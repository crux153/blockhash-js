// Perceptual image hash calculation tool based on algorithm descibed in
// Block Mean Value Based Image Perceptual Hashing by Bian Yang, Fan Gu and Xiamu Niu
//
// Copyright 2014 Commons Machinery http://commonsmachinery.se/
// Distributed under an MIT license, please see LICENSE in the top dir.
// 
!function(t){"use strict";var r=function(t,r){var a,n=[0,1,1,2,1,2,2,3,1,2,2,3,2,3,3,4],o=0;for(a=0;a<t.length;a++){var e=parseInt(t[a],16),h=parseInt(r[a],16);o+=n[e^h]}return o},a=function(t){var r=t.slice(0);return r.sort(function(t,r){return t-r}),r.length%2===0?(r[r.length/2]+r[r.length/2+1])/2:r[Math.floor(r.length/2)]},n=function(t,r){for(var n=256*r*3/2,o=t.length/4,e=0;4>e;e++)for(var h=a(t.slice(e*o,(e+1)*o)),i=e*o;(e+1)*o>i;i++){var f=t[i];t[i]=Number(f>h||Math.abs(f-h)<1&&h>n)}},o=function(t){for(var r=[],a=0;a<t.length;a+=4){var n=t.slice(a,a+4);r.push(parseInt(n.join(""),2).toString(16))}return r.join("")},e=function(t,r){for(var a=Math.floor(t.width/r),e=Math.floor(t.height/r),h=[],i=0;r>i;i++)for(var f=0;r>f;f++){for(var u=0,c=0;e>c;c++)for(var l=0;a>l;l++){var d=f*a+l,s=i*e+c,v=4*(s*t.width+d),g=t.data[v+3];u+=0===g?765:t.data[v]+t.data[v+1]+t.data[v+2]}h.push(u)}return n(h,a*e),o(h)},h=function(t,r){var a,h,i,f,u,c,l,d,s,v,g,w,M,m,p,I,b,L,j,R,U=[],E=[],k=t.width%r===0,O=t.height%r===0;if(k&&O)return e(t,r);for(a=0;r>a;a++)for(E.push([]),h=0;r>h;h++)E[a].push(0);for(u=t.width/r,c=t.height/r,f=0;f<t.height;f++)for(O?(g=w=Math.floor(f/c),l=1,d=0):(p=(f+1)%c,I=p-Math.floor(p),b=p-I,l=1-I,d=I,b>0||f+1===t.height?g=w=Math.floor(f/c):(g=Math.floor(f/c),w=Math.ceil(f/c))),i=0;i<t.width;i++){var x,y=4*(f*t.width+i),B=t.data[y+3];x=0===B?765:t.data[y]+t.data[y+1]+t.data[y+2],k?(M=m=Math.floor(i/u),s=1,v=0):(L=(i+1)%u,j=L-Math.floor(L),R=L-j,s=1-j,v=j,R>0||i+1===t.width?M=m=Math.floor(i/u):(M=Math.floor(i/u),m=Math.ceil(i/u))),E[g][M]+=x*l*s,E[g][m]+=x*l*v,E[w][M]+=x*d*s,E[w][m]+=x*d*v}for(a=0;r>a;a++)for(h=0;r>h;h++)U.push(E[a][h]);return n(U,u*c),o(U)},i=function(t,r,a){var n;if(1===a)n=e(t,r);else{if(2!==a)throw new Error("Bad hashing method");n=h(t,r)}return n},f={hash:function(t,r,a){return new Promise(function(n,o){r=r||16,a=a||2;var e=document.createElement("canvas"),h=e.getContext("2d"),f=URL.createObjectURL(t),u=new Image;u.addEventListener("load",function(){var t=this.naturalWidth,c=this.naturalHeight;e.width=t,e.height=c,h.drawImage(u,0,0),URL.revokeObjectURL(f);var l=h.getImageData(0,0,t,c);try{var d=i(l,r,a);n(d)}catch(s){o(s)}}),u.src=f})},distance:function(t,a){return r(t,a)}};t.blockhash=f}(window);